function setLocalStorage(){localStorage.getItem(xsyUser.id)||localStorage.setItem(xsyUser.id,JSON.stringify({index:{funnelData:"",rankData:"",oppData:""},opportunityHistory:"",accountHistory:""}))}function back(){$(".ct").length>0&&($(".ct").remove(),set_title("首页"),$("body").css({height:"",overflow:""}))}function sort(){if("behavior"==GetQueryString("page")){actLoad||(followSum(),get_record($("#recordList > .main"),20),actLoad=!0),$("#sort .behavior").addClass("active"),$("#sort .performance").removeClass("active"),$("#behaviorPage").show(),$("#performancePage").hide()}$("#sort .behavior").bind("click",function(){$(this).hasClass("active")||(actLoad||(followSum(),get_record($("#recordList > .main"),20),actLoad=!0),$(this).addClass("active"),$("#sort .performance").removeClass("active"),$("#behaviorPage").show(),$("#performancePage").hide())}),$("#sort .performance").bind("click",function(){$(this).hasClass("active")||($(this).addClass("active"),$("#sort .behavior").removeClass("active"),$("#performancePage").show(),$("#behaviorPage").hide())})}function selectors(){$(".selector").bind("click",function(e){"block"==$(this).find(".options").css("display")?$(this).find(".options").hide():($(".options").hide(),$(this).find(".options").show(),$(this).offset().top-$(window).scrollTop()-60>$(this).find(".options").height()?($(this).find(".options").addClass("upper"),$(this).find(".options").removeClass("lower")):($(this).find(".options").addClass("lower"),$(this).find(".options").removeClass("upper"))),e.stopPropagation()}),$(".options li").each(function(){$(this).bind("click",function(e){$(this).parent().parent().find("span").text($(this).text()),$(this).parent().hide(),e.stopPropagation()})}),$("body").bind("touchmove",function(){$(".options").hide()}),$("body").bind("click",function(){$(".options").hide()})}function get_funnel(){function e(){$.ajax({url:apppath+"/wx/char/salesfunnel.action",data:{searchDateType:funnelDateType},dataType:"json",success:function(e){if($("#performancePage .load-shadow").hide(),1==e.success){if(4==funnelDateType){var t;localStorage.getItem(xsyUser.id)&&"undefined"!=localStorage.getItem(xsyUser.id)?(t=JSON.parse(localStorage.getItem(xsyUser.id)),t.index={funnelData:e}):t={index:{funnelData:e}},localStorage.setItem(xsyUser.id,JSON.stringify(t))}funnelByData(e)}else e.entity&&e.entity.status&&"0000003"==e.entity.status?location.href=apppath+"/wx/authorized/no.action?"+ddcommparams:myAlert("暂时无法获取数据，请稍后再试")},error:function(){myAlert("暂时无法获取数据，请检查您的网络")}})}if($(".load-shadow").show(),4==funnelDateType&&localStorage.getItem(xsyUser.id)&&"undefined"!=localStorage.getItem(xsyUser.id)){var t=JSON.parse(localStorage.getItem(xsyUser.id));t.index&&t.index.funnelData&&1==t.index.funnelData.success&&funnelByData(t.index.funnelData)}$(".funnelTop .selector .options li").each(function(){$(this).bind("click",function(){funnelDateType=$(this).attr("value"),e()})}),e()}function funnelByData(e){var t=e.entity.total,n=e.entity.win,a=e.entity.estimateCompleted,i=999999,o="元",s="元",r="元";t>i&&(t/=1e4,t=Math.round(100*t)/100,o="万元"),n>i&&(n/=1e4,n=Math.round(100*n)/100,s="万元"),a>i&&(a/=1e4,a=Math.round(100*a)/100,r="万元"),$(".whole .value").text(t),$(".predict .value").text(a),$(".actual .value").text(n),$(".whole .label").text("漏斗总值("+o+")"),$(".predict .label").text("预计完成("+r+")"),$(".actual .label").text("实际完成("+s+")");var l=e.entity.series;if(0==l[0].count&&0==l[1].count&&0==l[2].count&&0==l[3].count)$(".noDataFunnel").show(),$(".funnelArea").hide(),$("#aim").hide(),$("#saleFunnel > .title").hide(),$("#saleFunnel").addClass("noData");else if($(".funnelArea").show(),$("#aim").show(),$("#saleFunnel > .title").show(),$(".noDataFunnel").hide(),$("#saleFunnel").removeClass("noData"),"金额"==$("#saleFunnel .btn").text()){var d=l[0].amount,c=l[1].amount,p=l[2].amount,u=l[3].amount,h="元";(d>i||c>i||p>i||u>i)&&(h="(万元)",d/=1e4,d=Math.round(100*d)/100,c/=1e4,c=Math.round(100*c)/100,p/=1e4,p=Math.round(100*p)/100,u/=1e4,u=Math.round(100*u)/100),$("#leftLine .line1 .info").text(l[0].name),$("#rightLine .line1 .info").text(d+h),$("#leftLine .line2 .info").text(l[1].name),$("#rightLine .line2 .info").text(c+h),$("#leftLine .line3 .info").text(l[2].name),$("#rightLine .line3 .info").text(p+h),$("#leftLine .line4 .info").text(l[3].name),$("#rightLine .line4 .info").text(u+h),funnel(l[0].amount,l[1].amount,l[2].amount,l[3].amount)}else"个数"==$("#saleFunnel .btn").text()&&($("#leftLine .line1 .info").text(l[0].name),$("#rightLine .line1 .info").text(l[0].count),$("#leftLine .line2 .info").text(l[1].name),$("#rightLine .line2 .info").text(l[1].count),$("#leftLine .line3 .info").text(l[2].name),$("#rightLine .line3 .info").text(l[2].count),$("#leftLine .line4 .info").text(l[3].name),$("#rightLine .line4 .info").text(l[3].count),funnel(l[0].count,l[1].count,l[2].count,l[3].count))}function change_funnel(){$("#saleFunnel .btn").bind("click",function(){"个数"==$(this).text()?($(this).text("金额"),$(this).parent().find("span").text("(元)")):"金额"==$(this).text()&&($(this).text("个数"),$(this).parent().find("span").text("(个)")),get_funnel()})}function funnel(e,t,n,a){var i=35,o=$("#funnel").height(),s=o/(e+t+n+a)*a,r=o/(e+t+n+a)*n,l=o/(e+t+n+a)*t,d=o/(e+t+n+a)*e;i>s&&(s=i),i>r&&(r=i),i>l&&(l=i),i>d&&(d=i);var c=r/8*4,p=l/8*4,u=d/8*4,h=$("#funnel .funnel4").width(),f=h,m=f+2*c,g=m+2*p;$("#funnel .funnel4").css({borderTopWidth:s}),$("#funnel .funnel3").css({borderTopWidth:r,width:f,borderLeftWidth:c,borderRightWidth:c}),$("#funnel .funnel2").css({borderTopWidth:l,width:m,borderLeftWidth:p,borderRightWidth:p}),$("#funnel .funnel1").css({borderTopWidth:d,width:g,borderLeftWidth:u,borderRightWidth:u});var y=$(".line").height(),v=$("#funnel .funnel1").position().top+parseInt($("#funnel .funnel1").css("borderTopWidth"))-y-2,b=$("#funnel .funnel2").position().top+.8*parseInt($("#funnel .funnel2").css("borderTopWidth"))-y-2,x=$("#funnel .funnel3").position().top+.8*parseInt($("#funnel .funnel3").css("borderTopWidth"))-y-2,w=$("#funnel .funnel4").position().top+parseInt($("#funnel .funnel4").css("borderTopWidth"))-y-2;y>w-x&&(x=w-y-2),y>x-b&&(b=x-y-2),y>b-v&&(v=b-y-2);var _=($("#saleFunnel").width()-$("#funnel .funnel1").width())/2-80,S=($("#saleFunnel").width()-$("#funnel .funnel2").width()-p)/2-70,k=($("#saleFunnel").width()-$("#funnel .funnel3").width()-c)/2-70,D=($("#saleFunnel").width()-$("#funnel .funnel4").width())/2-70;$("#leftLine .line1").css({top:v-15,width:_}),$("#leftLine .line2").css({top:b-5,width:S}),$("#leftLine .line3").css({top:x,width:k}),$("#leftLine .line4").css({top:w-2,width:D}),$("#rightLine .line1").css({top:v-15,width:_}),$("#rightLine .line2").css({top:b-5,width:S}),$("#rightLine .line3").css({top:x,width:k}),$("#rightLine .line4").css({top:w-2,width:D})}function actSumSelect(){$(".load-shadow").show(),$(".actSum .selector .options li").each(function(){$(this).bind("click",function(){actDateType=$(this).attr("value"),followSum()})})}function followSum(){$(".actSum .list").children().remove(),$.ajax({url:apppath+"/wx/statics/activerecords.action",data:{searchDateType:actDateType},dataType:"json",success:function(e){$("#behaviorPage .load-shadow").hide(),console.log("跟进汇总："+e),1==e.success?actSumByData(e):e.entity&&e.entity.status&&"0000003"==e.entity.status?location.href=apppath+"/wx/authorized/no.action?"+ddcommparams:console.log("暂时无法获取数据，请稍后再试")},error:function(){myAlert("暂时无法获取数据，请检查您的网络")}})}function actSumByData(e){function t(){var e=$('<li class="boxSizing"> <em class="'+o+'"></em> <div> <span class="name">'+r+'</span> <span class="num">'+l+s+'</span> </div> <span class="count">'+d+"</span> </li>");1*d>0?e.find(".count").addClass("more"):0>1*d&&e.find(".count").addClass("less"),$(".actSum > ul").append(e)}for(var n=e.entity,a=0,i=n.length;i>a;a++){var o,s,r=n[a].text,l=n[a].count,d=(n[a].compare,n[a].count);"新建商机"==r?(r="新增销售机会",s="个",o="shangji",t()):"新建客户"==r?(r="新增公司",s="个",o="gongsi",t()):"电话"==r?(s="个",o="dianhua",t()):"拜访签到"==r?(r="签到",s="次",o="qiandao",t()):"记录"==r&&(s="个",o="jilu",t())}}function get_rank(){if($(".load-shadow").show(),localStorage.getItem(xsyUser.id)){var e=JSON.parse(localStorage.getItem(xsyUser.id));e.index&&e.index.rankData&&1==e.index.rankData.success&&ranking(e.index.rankData)}$(".ranking .options li").each(function(){$(this).bind("click",function(){1==$(this).index()&&(rankDateType=4,$(".ranking .selector > span").text("本月")),2==$(this).index()&&(rankDateType=3,$(".ranking .selector > span").text("上月")),3==$(this).index()&&(rankDateType=7,$(".ranking .selector > span").text("本季")),4==$(this).index()&&(rankDateType=6,$(".ranking .selector > span").text("上季")),5==$(this).index()&&(rankDateType=10,$(".ranking .selector > span").text("本年")),6==$(this).index()&&(rankDateType=9,$(".ranking .selector > span").text("上年")),$(".ranking .list").children().remove(),$(".ranking .searchMore").remove(),get_rank_data(rankDateType)})})}function get_rank_data(e){console.log("rankDateType:"+e),$.ajax({url:apppath+"/wx/char/salesRank.action",data:{searchDateType:e},dataType:"json",success:function(t){if($("#performancePage .load-shadow").hide(),1==t.success){if(4==e){var n;localStorage.getItem(xsyUser.id)?(n=JSON.parse(localStorage.getItem(xsyUser.id)),n.index={rankData:t}):n={index:{rankData:t}},localStorage.setItem(xsyUser.id,JSON.stringify(n))}ranking(t)}else t.entity&&t.entity.status&&"0000003"==t.entity.status?location.href=apppath+"/wx/authorized/no.action?"+ddcommparams:myAlert("暂时无法获取数据，请稍后再试")},error:function(){myAlert("暂时无法获取数据，请检查您的网络")}})}function ranking(e){function t(t,n){t.children().remove();for(var a=0;n>a;a++){var i=Number(e.entity.series[a].ord)+1;10>i&&(i="0"+String(i));var o=e.entity.series[a].userName,s=e.entity.series[a].money,r=$('<li> <span class="label">'+i+'</span> <span class="name">'+o+'</span> <p class="pillowBlock"><span class="pillow"></span></p> <span class="value">'+s+"</span> </li>"),l=e.entity.series[a].userId;xsyUser?xsyUser.id==l&&r.addClass("myself"):myAlert("未获取到当前用户"),t.append(r)}var d=t.find("li").width()-t.find("li").eq(0).find(".value").width()-190;t.find("li").eq(0).find(".pillow").css("width",d),t.find(".pillowBlock").css("width",d);for(var a=1;n>a;a++){var c=d/e.entity.series[0].money*e.entity.series[a].money;3>=c&&(c=3),t.find("li").eq(a).find(".pillow").css("width",c)}}console.log(e),0==e.entity.series.length||0==e.entity.series[0].money?($("#ranking .list").hide(),$("#ranking .noDataRanking").show()):($("#ranking .list").show(),$("#ranking .noDataRanking").hide());var n=10;e.entity.series.length<=10&&(n=e.entity.series.length),t($("#ranking .list"),n),$(".ct").length>0&&t($(".ct .list"),e.entity.series.length),e.entity.series.length>10&&($("#ranking .searchMore").remove(),$("#ranking").append('<div class="searchMore">查看全部</div>'),$(".searchMore").bind("click",function(){checkTable("业绩排名"),$(".ct").addClass("ranking");var n=$('<div class="title boxSizing"><p class="label">业绩总值</p><p class="value">'+e.entity.totalCount+"元</p></div>"),a=$('<div class="selector"> <span>本月</span> <ul class="options lower boxSizing"> <div class="triangle"></div> <li class="boxSizing">本月</li> <li class="boxSizing">上月</li> <li class="boxSizing">本季</li> <li class="boxSizing">上季</li> <li class="boxSizing">本年</li> <li class="boxSizing">上年</li> </ul> </div>');a.find("span").eq(0).text($("#ranking .selector >span").text()),n.append(a),a.bind("click",function(){return"block"==$(this).find(".options").css("display")?$(this).find(".options").hide():$(this).find(".options").show(),!1});var i=$('<ul class="list boxSizing"></ul>');$(".ct").append(n),$(".ct").append(i),t($(".ct .list"),e.entity.series.length),get_rank()}))}function recordSelect(){$(".load-shadow").show(),$("#recordList .selector .options li").each(function(){$(this).bind("click",function(){recordDateType=$(this).attr("value"),recordPageNo=0,$("#recordList > .main").children().remove(),get_record($("#recordList > .main"),20)})})}function get_record(e){$.ajax({url:apppath+"/wx/statics/activerecordlist.action",data:{pagesize:20,pageNo:recordPageNo,searchDateType:recordDateType},dataType:"json",success:function(t){$("#behaviorPage .load-shadow").hide(),console.log("跟进记录："+t),1==t.success?recordByData(t,e):t.entity&&t.entity.status&&"0000003"==t.entity.status?location.href=apppath+"/wx/authorized/no.action?"+ddcommparams:(myAlert("暂时无法获取数据，请稍后再试"),console.log("跟进记录："+t))},error:function(){myAlert("暂时无法获取数据，请检查您的网络")}})}function recordByData(e,t){var n=e.entity.totalSize;$("#recordList > .top > .title > span").text("跟进记录("+n+")"),0==e.entity.records.length?(t.append($('<div class="noInfo">该范围内没有跟进记录</div>')),console.log("该对象暂无跟进记录")):(build_record_list(t,e),t.find("li").length<n?($("#loading").remove(),build_end(t,"加载更多","load_more"),recordPageNo++,scroll_load()):$("#loading").remove())}function build_end(e,t,n){var a=$('<div id="'+n+'" class="end_info">'+t+"</div>");e.append(a)}function scroll_load(){var e=document.body.clientHeight;$(window).bind("scroll",function(){$("#load_more").length>0&&$("#load_more").offset().top-$(document).scrollTop()<=e-$("#load_more").height()-50&&($("#load_more").remove(),build_end($("#recordList > .main"),"加载中…","loading"),get_record($("#recordList > .main"),20),$(this).unbind("scroll"))})}function build_record_list(e,t){for(var n=t.entity.records,a=0;a<n.length;a++){var i=n[a].user.userName,o=n[a].typeName,s=n[a].objectName,r=n[a].belongId,l=n[a].objectId,d=n[a].startTime.substr(-5),c=n[a].startTime.substr(0,11),p=n[a].recordType.type;if(0!=a&&n[a].startTime.substr(0,11)!=n[a-1].startTime.substr(0,11))if(0==a&&e.find(".day").last().text==n[a].startTime.substr(0,11));else{var u=$('<div class="day"><em></em><p class="startDate">'+c+'</p><div class="ban"></div></div>');e.append(u)}else if(0==a&&0==recordPageNo){var u=$('<div class="day"><em></em><p class="startDate">'+c+'</p><div class="ban"></div></div>');e.append(u)}var h=$('<li class="boxSizing"><div class="info"><span class="userName">'+i+'</span><span class="typeName">'+o+':</span><span class="objectName">'+s+'</span><span class="startTime">'+d+"</span></div></li>");if(h.find(".objectName").attr({belongId:r,objectId:l}),h.find(".objectName").bind("click",function(){var e;1==$(this).attr("belongId")?e=apppath+"/wx/account/info.action?"+ddcommparams+"&accountId="+$(this).attr("objectId")+"&from=index&page=behavior":2==$(this).attr("belongId")?e=apppath+"/wx/contact/info.action?"+ddcommparams+"&contactId="+$(this).attr("objectId")+"&from=index&page=behavior":3==$(this).attr("belongId")&&(e=apppath+"/wx/opportunity/detail.action?"+ddcommparams+"&opportunityId="+$(this).attr("objectId")+"&from=index&page=behavior"),location.href=e}),"TEL"==p?h.addClass("phone_bg"):"SIGN_IN"==p?h.addClass("sign_in_bg"):"RECORD"==p&&h.addClass("record_bg"),n[a].content){var f=n[a].content,m=$('<span class="content_span">'+f+"</span>"),g=$('<div class="content"><em class="triangle"></em></div>');if(g.append(m),f.length>32){var y=f.substr(0,30)+"...",v=$('<span class="short_content_span">'+y+"</span>");g.append(v),m.css("display","none");var b=0,x=$('<em class="more"></em>');x.bind("click",function(){b++,$(this).parent().find(".short_content_span").slideToggle(),$(this).parent().find(".content_span").slideToggle(),$(this).css("transform","rotate("+(90+180*b)+"deg)")}),g.append(x)}h.append(g)}if(n[a].location){var w=$('<div class="location">'+n[a].location+"</div>");h.append(w)}var _=$('<div class="bottom_border"></div>');h.append(_),e.append(h)}removeBorder()}function removeBorder(){$("#record_tab li").each(function(){$(this).next().hasClass("day")&&$(this).find(".bottom_border").remove()})}function build_list_unit(e,t,n){var a=e.entity.records[n],i=a.saleStageText,o=a.opportunityName,s=a.money,r=a.accountName,l=a.id,d=a.saleStageOrder,c=a.saleStagePercentage,p=$('<li class="boxSizing"><em class="icon"></em><div class="info"><div class="top"><span class="opportunityName">'+o+'</span><span class="Money boxSizing">'+s+'元</span></div><div class="bot"><p class="accountName">'+r+'</p><p class="jieduan">阶段：'+i+'</p><span class="jieduan_p">'+c+"%</span></div></div></li>");p.attr("id",l),p.attr("name",o),p.find(".icon").addClass("jieduan"+d),p.bind("click",function(){location.href=apppath+"/wx/opportunity/detail.action?"+ddcommparams+"&opportunityId="+$(this).attr("id")+"&from=index"}),t.append(p)}function listScrollFunc(){$("#content").bind("scroll",function(){$("#load_more").length>0&&$("#load_more").offset().top<=$(window).height()-$("#load_more").height()-53&&($("#load_more.end_info").remove(),$("#list .main").append($('<div id="loading" class="end_info">加载中…</div>')),build_opp_list(apppath+"/wx/statics/topopportunity.action",$("#list .main"),build_list_unit,listScrollFunc,"scroll"))})}function opp_options(){$(".load-shadow").show(),$("#list .selector .options li").each(function(){$(this).bind("click",function(){oppDateType=$(this).attr("value"),pageNo=0,build_opp_list(apppath+"/wx/statics/topopportunity.action",$("#list .main"),build_list_unit,listScrollFunc)})})}function build_opp_list(e,t,n,a,i){obj={pageNo:pageNo,pagesize:pageSize,searchDateType:oppDateType},$.ajax({url:e,data:obj,async:!1,dataType:"json",success:function(e){if($("#performancePage .load-shadow").hide(),1==e.success){if(4==oppDateType){var o;localStorage.getItem(xsyUser.id)?(o=JSON.parse(localStorage.getItem(xsyUser.id)),o.index={oppData:e}):o={index:{oppData:e}},localStorage.setItem(xsyUser.id,JSON.stringify(o))}oppListByData(e,t,n,a,i)}else e.entity&&e.entity.status&&"0000003"==e.entity.status?location.href=apppath+"/wx/authorized/no.action?"+ddcommparams:myAlert("暂时无法获取数据，请稍后再试")},error:function(){myAlert("暂时无法获取数据，请检查您的网络")}})}function oppListByData(e,t,n,a,i){"scroll"!=i&&t.children().remove();var o,s=e.entity.records.length;if(0==s)t.append($('<div class="noInfo">该范围内没有重点销售机会</div>'));else{o=s-pageNo*pageSize>pageSize?pageSize:s-pageNo*pageSize;for(var r=0;o>r;r++)n(e,t,r);t.children().length<s&&t.append($('<div id="load_more" class="end_info">加载更多</div>')),obj.pageNo++,pageNo++,$("#loading").remove(),a()}}$(document).bind("ready",function(){setLocalStorage(),selectors(),sort(),actSumSelect(),recordSelect(),get_funnel(),change_funnel(),get_rank(),get_rank_data(rankDateType),opp_options(),build_opp_list(apppath+"/wx/statics/topopportunity.action",$("#list .main"),build_list_unit,listScrollFunc)}),$(document).ready(function(){control_back(back),remove_rTop()});var pageNo=0,pageSize=10,oppDateType=4,obj={pageNo:pageNo,pagesize:pageSize,searchDateType:oppDateType},actLoad=!1,funnelDateType=4,actDateType=1,rankDateType=4,mydata={entity:{series:[{ord:0,userId:75918,userName:"天天他",money:1e7},{ord:1,userId:34234,userName:"rete",money:4122220},{ord:2,userId:56565,userName:"尔特让",money:3332320},{ord:3,userId:34345,userName:"儿儿",money:2262220},{ord:4,userId:94524,userName:"有人人",money:666660},{ord:5,userId:45336,userName:"一天",money:658650},{ord:6,userId:56425,userName:"人额",money:76780},{ord:7,userId:36354,userName:"而人额",money:76770},{ord:8,userId:24455,userName:"人员",money:8670},{ord:9,userId:22222,userName:"河野谈",money:6660},{ord:10,userId:34341,userName:"发送的",money:210},{ord:11,userId:12213,userName:"发毒素",money:0},{ord:12,userId:22222,userName:"河野谈",money:6660},{ord:13,userId:34341,userName:"发送的",money:210},{ord:14,userId:12213,userName:"发毒素",money:0},{ord:15,userId:22222,userName:"河野谈",money:6660},{ord:16,userId:34341,userName:"发送的",money:2112330},{ord:17,userId:12213,userName:"发毒素",money:0}]},success:!0},recordDateType=1,recordPageNo=0;